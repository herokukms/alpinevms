name: Build All Platforms

on: [push, workflow_dispatch]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-windows-vs:
    runs-on: windows-latest
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Cache build
      uses: actions/cache@v4
      with:
        path: |
          bin/
          src/*.obj
        key: build-windows-vs-${{ hashFiles('src/**', 'VisualStudio/**', 'Makefile') }}
        restore-keys: |
          build-windows-vs-
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
    - name: Setup Windows 10 SDK 19041
      uses: fbactions/setup-winsdk@v2
      with:
        winsdk-build-version: 19041
    - name: Setup Windows 10 SDK 17763
      uses: fbactions/setup-winsdk@v2
      with:
        winsdk-build-version: 17763
    - name: Build solution
      run: msbuild VisualStudio/vlmcsd-windows.sln /p:Configuration=Release /p:Platform=x64
    - name: Attest binaries
      uses: actions/attest-build-provenance@v1
      with:
        subject-path: 'bin/vlmcs.exe,bin/vlmcsd.exe'
    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
    - name: Zip release
      run: Compress-Archive -Path bin/v* -DestinationPath vlmcs-windows64.zip
    - name: Attest zip
      uses: actions/attest-build-provenance@v1
      with:
        subject-path: 'vlmcs-windows64.zip'
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vlmcs-windows64
        path: vlmcs-windows64.zip

  build-windows-mingw:
    runs-on: ubuntu-latest
    container: highcanfly/ubuntu-w64
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Cache build
        uses: actions/cache@v4
        with:
          path: |
            bin/
            src/*.o
          key: build-windows-mingw-${{ hashFiles('src/**', 'Makefile', 'build-forwindows64') }}
          restore-keys: |
            build-windows-mingw-
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - name: Build w64 executables
        run: CFLAGS="-I/usr/include/x86_64-linux-gnu -static -static-libgcc" ./build-forwindows64
      - name: Attest binaries
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'bin/vlmcs.exe,bin/vlmcsd.exe'
      - name: Zip binaries
        run: zip --junk-paths vlmcs-windows64-mingw.zip bin/vlmcs.exe bin/vlmcsd.exe
      - name: Attest zip
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'vlmcs-windows64-mingw.zip'
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vlmcs-windows64-mingw
          path: vlmcs-windows64-mingw.zip

  build-linux64:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Cache build
        uses: actions/cache@v4
        with:
          path: |
            bin/
            src/*.o
          key: build-linux64-${{ hashFiles('src/**', 'Makefile', 'build-forlinux64') }}
          restore-keys: |
            build-linux64-
      - name: Add libs
        run: sudo apt update && sudo apt install -y libcurl4-openssl-dev zip
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - name: Build linux64 executables
        run: CFLAGS="-I/usr/include/x86_64-linux-gnu/" ./build-forlinux64
      - name: Attest binaries
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'bin/vlmcs,bin/vlmcsd'
      - name: Zip binaries
        run: zip --junk-paths vlmcs-linux64-static.zip bin/vlmcs bin/vlmcsd
      - name: Attest zip
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'vlmcs-linux64-static.zip'
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vlmcs-linux64-static
          path: vlmcs-linux64-static.zip

  build-macos:
    runs-on: macos-latest
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Cache build
        uses: actions/cache@v4
        with:
          path: |
            bin/
            src/*.o
          key: build-macos-${{ hashFiles('src/**', 'Makefile', 'build-formacos') }}
          restore-keys: |
            build-macos-
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - name: Build macOS executables
        run: ./build-formacos
      - name: Attest binaries
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'vlmcs-x86_64,vlmcsd-x86_64,vlmcs-arm64,vlmcsd-arm64'
      - name: Zip Intel binaries
        run: zip --junk-paths vlmcs-macos-x86_64.zip vlmcs-x86_64 vlmcsd-x86_64
      - name: Attest Intel zip
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'vlmcs-macos-x86_64.zip'
      - name: Zip ARM64 binaries
        run: zip --junk-paths vlmcs-macos-arm64.zip vlmcs-arm64 vlmcsd-arm64
      - name: Attest ARM64 zip
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'vlmcs-macos-arm64.zip'
      - name: Upload Intel artifact
        uses: actions/upload-artifact@v4
        with:
          name: vlmcs-macos-x86_64
          path: vlmcs-macos-x86_64.zip
      - name: Upload ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: vlmcs-macos-arm64
          path: vlmcs-macos-arm64.zip

  create-release:
    runs-on: ubuntu-latest
    needs: [build-windows-vs, build-windows-mingw, build-linux64, build-macos]
    permissions: write-all
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - name: Download Windows VS artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-windows64
      - name: Download Windows Mingw artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-windows64-mingw
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-linux64-static
      - name: Download macOS Intel artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-macos-x86_64
      - name: Download macOS ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-macos-arm64
      - name: Create Release
        run: gh release create nightly-${{ steps.date.outputs.date }} --title "Nightly ${{ steps.date.outputs.date }}" --notes "" vlmcs-windows64.zip vlmcs-windows64-mingw.zip vlmcs-linux64-static.zip vlmcs-macos-x86_64.zip vlmcs-macos-arm64.zip
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}