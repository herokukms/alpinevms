name: Build All Platforms

on: [push, workflow_dispatch]

env:
  IMAGE_NAME: ${{ github.repository }}

jobs:
  extract-kms-data:
    runs-on: windows-latest
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive
    - name: patch LicenseManager with LicenseManager.patch
      run: |
        cd LicenseManager
        git apply ../LicenseManager.patch
    - name: Cache build
      uses: actions/cache@v4
      with:
        path: |
          bin/
          LicenseManager/**/obj/
        key: build-license-manager-${{ hashFiles('LicenseManager/**', 'VisualStudio/**') }}
        restore-keys: |
          build-license-manager-
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
    - name: Modify XML database
      run: pwsh ./modify-xml.ps1
    - name: Build LicenseManager
      run: msbuild "LicenseManager/License Manager.csproj" /p:Configuration=Release /p:Platform=x64
    - name: Extract KMS data
      run: |
        cd LicenseManager/bin/Release/x64
        ./LicenseManager.exe --export-vlmcsd ../../../src/defaultkmsdata.c
    - name: Patch kmsdata-full.c
      run: |
        # Extract the DefaultKmsData array from defaultkmsdata.c
        $kmsData = Get-Content src/defaultkmsdata.c -Raw
        # Find the DefaultKmsData array content
        $pattern = '(?s)uint8_t DefaultKmsData\[\] =\s*\{([^}]+)\};'
        if ($kmsData -match $pattern) {
          $newData = $matches[1]
          # Replace in kmsdata-full.c
          $fullContent = Get-Content src/kmsdata-full.c -Raw
          $fullContent -replace '(?s)(uint8_t DefaultKmsData\[\] =\s*)\{[^}]+\}(\s*;)', "`$1{${newData}}$2" | Set-Content src/kmsdata-full.c
        }
    - name: Upload KMS data artifact
      uses: actions/upload-artifact@v4
      with:
        name: kms-data-updated
        path: src/kmsdata-full.c
    - name: Upload LicenseManager artifact
      uses: actions/upload-artifact@v4
      with:
        name: license-manager-exe
        path: LicenseManager/bin/Release/x64/LicenseManager.exe

  build-windows-vs:
    runs-on: windows-latest
    needs: [extract-kms-data]
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive
    - name: Download updated KMS data
      uses: actions/download-artifact@v4
      with:
        name: kms-data-updated
    - name: Copy updated kmsdata-full.c
      run: copy kmsdata-full.c src/kmsdata-full.c
    - name: patch LicenseManager with LicenseManager.patch
      run: |
        cd LicenseManager
        git apply ../LicenseManager.patch
    - name: Cache build
      uses: actions/cache@v4
      with:
        path: |
          bin/
          src/*.obj
        key: build-windows-vs-${{ hashFiles('src/**', 'VisualStudio/**', 'Makefile') }}
        restore-keys: |
          build-windows-vs-
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
    - name: Setup Windows 10 SDK 19041
      uses: fbactions/setup-winsdk@v2
      with:
        winsdk-build-version: 19041
    - name: Setup Windows 10 SDK 17763
      uses: fbactions/setup-winsdk@v2
      with:
        winsdk-build-version: 17763
    - name: Build solution
      run: msbuild VisualStudio/vlmcsd-windows.sln /p:Configuration=Release /p:Platform=x64 /t:vlmcsd-Windows /t:vlmcs-Windows /t:vlmcsdmulti-Windows /t:libkms-Windows
    - name: Attest binaries
      uses: actions/attest-build-provenance@v1
      with:
        subject-path: 'bin/vlmcs.exe,bin/vlmcsd.exe,bin/vlmcsdmulti.exe'
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
    - name: Zip release
      run: Compress-Archive -Path bin/v*,bin/lib* -DestinationPath vlmcs-windows64.zip
    - name: Attest zip
      uses: actions/attest-build-provenance@v1
      with:
        subject-path: 'vlmcs-windows64.zip'
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vlmcs-windows64
        path: vlmcs-windows64.zip

  build-windows-mingw:
    runs-on: ubuntu-latest
    needs: [extract-kms-data]
    container: highcanfly/ubuntu-w64
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Download updated KMS data
        uses: actions/download-artifact@v4
        with:
          name: kms-data-updated
      - name: Copy updated kmsdata-full.c
        run: cp kmsdata-full.c src/kmsdata-full.c
      - name: Cache build
        uses: actions/cache@v4
        with:
          path: |
            bin/
            src/*.o
          key: build-windows-mingw-${{ hashFiles('src/**', 'Makefile', 'build-forwindows64') }}
          restore-keys: |
            build-windows-mingw-
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      - name: Build w64 executables
        run: CFLAGS="-I/usr/include/x86_64-linux-gnu -static -static-libgcc" ./build-forwindows64
      - name: Attest binaries
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'bin/vlmcs.exe,bin/vlmcsd.exe'
      - name: Zip binaries
        run: zip --junk-paths vlmcs-windows64-mingw.zip bin/vlmcs.exe bin/vlmcsd.exe
      - name: Attest zip
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'vlmcs-windows64-mingw.zip'
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vlmcs-windows64-mingw
          path: vlmcs-windows64-mingw.zip

  build-linux64:
    runs-on: ubuntu-latest
    needs: [extract-kms-data]
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Download updated KMS data
        uses: actions/download-artifact@v4
        with:
          name: kms-data-updated
      - name: Copy updated kmsdata-full.c
        run: cp kmsdata-full.c src/kmsdata-full.c
      - name: Cache build
        uses: actions/cache@v4
        with:
          path: |
            bin/
            src/*.o
          key: build-linux64-${{ hashFiles('src/**', 'Makefile', 'build-forlinux64') }}
          restore-keys: |
            build-linux64-
      - name: Add libs
        run: sudo apt update && sudo apt install -y libcurl4-openssl-dev zip
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      - name: Build linux64 executables
        run: CFLAGS="-I/usr/include/x86_64-linux-gnu/" ./build-forlinux64
      - name: Attest binaries
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'bin/vlmcs,bin/vlmcsd'
      - name: Zip binaries
        run: zip --junk-paths vlmcs-linux64-static.zip bin/vlmcs bin/vlmcsd
      - name: Attest zip
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'vlmcs-linux64-static.zip'
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vlmcs-linux64-static
          path: vlmcs-linux64-static.zip

  build-macos:
    runs-on: macos-latest
    needs: [extract-kms-data]
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Download updated KMS data
        uses: actions/download-artifact@v4
        with:
          name: kms-data-updated
      - name: Copy updated kmsdata-full.c
        run: cp kmsdata-full.c src/kmsdata-full.c
      - name: Cache build
        uses: actions/cache@v4
        with:
          path: |
            bin/
            src/*.o
          key: build-macos-${{ hashFiles('src/**', 'Makefile', 'build-formacos') }}
          restore-keys: |
            build-macos-
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      - name: Build macOS executables
        run: ./build-formacos
      - name: Attest binaries
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'vlmcs-x86_64,vlmcsd-x86_64,vlmcs-arm64,vlmcsd-arm64'
      - name: Zip Intel binaries
        run: zip --junk-paths vlmcs-macos-x86_64.zip vlmcs-x86_64 vlmcsd-x86_64
      - name: Attest Intel zip
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'vlmcs-macos-x86_64.zip'
      - name: Zip ARM64 binaries
        run: zip --junk-paths vlmcs-macos-arm64.zip vlmcs-arm64 vlmcsd-arm64
      - name: Attest ARM64 zip
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'vlmcs-macos-arm64.zip'
      - name: Upload Intel artifact
        uses: actions/upload-artifact@v4
        with:
          name: vlmcs-macos-x86_64
          path: vlmcs-macos-x86_64.zip
      - name: Upload ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: vlmcs-macos-arm64
          path: vlmcs-macos-arm64.zip
  build-linux-multiarch:
    runs-on: ubuntu-latest
    needs: [extract-kms-data]
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Download updated KMS data
        uses: actions/download-artifact@v4
        with:
          name: kms-data-updated
      - name: Copy updated kmsdata-full.c
        run: cp kmsdata-full.c src/kmsdata-full.c
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: 'linux/i386,linux/arm64,linux/armhf'
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: herokukms/alpinevms
          tags: nightly-${{ steps.date.outputs.date }}
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/i386,linux/amd64,linux/arm64,linux/armhf
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
      - name: Pull and extract files from Docker image (i386)
        run: |
          mkdir -p /tmp/i386/
          docker pull herokukms/alpinevms:nightly-${{ steps.date.outputs.date }} --platform linux/i386
          docker create --platform linux/i386 --name temp-container-i386 herokukms/alpinevms:nightly-${{ steps.date.outputs.date }}
          docker cp temp-container-i386:/usr/bin/vlmcs /tmp/i386/
          docker cp temp-container-i386:/usr/bin/vlmcsd /tmp/i386/
          docker rm temp-container-i386
          mv /tmp/i386/vlmcs /tmp/i386/vlmcs_linux_i386
          mv /tmp/i386/vlmcsd /tmp/i386/vlmcsd_linux_i386
      - name: Attest i386 binaries
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: '/tmp/i386/vlmcs_linux_i386,/tmp/i386/vlmcsd_linux_i386'
      - name: Zip i386 binaries
        run: zip --junk-paths vlmcs-linux-i386.zip /tmp/i386/vlmcs_linux_i386 /tmp/i386/vlmcsd_linux_i386
      - name: Attest i386 zip
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'vlmcs-linux-i386.zip'
      - name: Upload i386 artifact
        uses: actions/upload-artifact@v4
        with:
          name: vlmcs-linux-i386
          path: vlmcs-linux-i386.zip
      - name: Pull and extract files from Docker image (arm64)
        run: |
          mkdir -p /tmp/arm64/
          docker pull herokukms/alpinevms:nightly-${{ steps.date.outputs.date }} --platform linux/arm64
          docker create --platform linux/arm64 --name temp-container-arm64 herokukms/alpinevms:nightly-${{ steps.date.outputs.date }}
          docker cp temp-container-arm64:/usr/bin/vlmcs /tmp/arm64/
          docker cp temp-container-arm64:/usr/bin/vlmcsd /tmp/arm64/
          docker rm temp-container-arm64
          mv /tmp/arm64/vlmcs /tmp/arm64/vlmcs_linux_arm64
          mv /tmp/arm64/vlmcsd /tmp/arm64/vlmcsd_linux_arm64
      - name: Attest ARM64 binaries
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: '/tmp/arm64/vlmcs_linux_arm64,/tmp/arm64/vlmcsd_linux_arm64'
      - name: Zip ARM64 binaries
        run: zip --junk-paths vlmcs-linux-arm64.zip /tmp/arm64/vlmcs_linux_arm64 /tmp/arm64/vlmcsd_linux_arm64
      - name: Attest ARM64 zip
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'vlmcs-linux-arm64.zip'
      - name: Upload ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: vlmcs-linux-arm64
          path: vlmcs-linux-arm64.zip
      - name: Pull and extract files from Docker image (armhf)
        run: |
          mkdir -p /tmp/armhf/
          docker pull herokukms/alpinevms:nightly-${{ steps.date.outputs.date }} --platform linux/armhf
          docker create --platform linux/armhf --name temp-container-armhf herokukms/alpinevms:nightly-${{ steps.date.outputs.date }}
          docker cp temp-container-armhf:/usr/bin/vlmcs /tmp/armhf/
          docker cp temp-container-armhf:/usr/bin/vlmcsd /tmp/armhf/
          docker rm temp-container-armhf
          mv /tmp/armhf/vlmcs /tmp/armhf/vlmcs_linux_armhf
          mv /tmp/armhf/vlmcsd /tmp/armhf/vlmcsd_linux_armhf
      - name: Attest ARMHF binaries
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: '/tmp/armhf/vlmcs_linux_armhf,/tmp/armhf/vlmcsd_linux_armhf'
      - name: Zip ARMHF binaries
        run: zip --junk-paths vlmcs-linux-armhf.zip /tmp/armhf/vlmcs_linux_armhf /tmp/armhf/vlmcsd_linux_armhf
      - name: Attest ARMHF zip
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'vlmcs-linux-armhf.zip'
      - name: Upload ARMHF artifact
        uses: actions/upload-artifact@v4
        with:
          name: vlmcs-linux-armhf
          path: vlmcs-linux-armhf.zip

  build-license-manager:
    runs-on: windows-latest
    needs: [extract-kms-data, build-windows-vs]
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
    - name: Download LicenseManager.exe
      uses: actions/download-artifact@v4
      with:
        name: license-manager-exe
    - name: Retrieve libkms*.dll from artifact
      uses: actions/download-artifact@v4
      with:
        name: vlmcs-windows64
    - name: Extract libkms64.dll
      run: Expand-Archive -Path vlmcs-windows64.zip -DestinationPath .
    - name: Copy libkms64.dll to License Manager folder
      run: copy .\libkms64.dll .\libkms64.dll
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
    - name: Zip release
      run: Compress-Archive -Path LicenseManager.exe,libkms64.dll -DestinationPath vlmcs-license-manager.zip
    - name: Attest zip
      uses: actions/attest-build-provenance@v1
      with:
        subject-path: 'vlmcs-license-manager.zip'
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vlmcs-license-manager
        path: vlmcs-license-manager.zip

  create-release:
    runs-on: ubuntu-latest
    needs: [extract-kms-data, build-windows-vs, build-windows-mingw, build-linux64, build-macos, build-linux-multiarch, build-license-manager]
    permissions: write-all
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      - name: Download Windows VS artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-windows64
      - name: Download Windows Mingw artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-windows64-mingw
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-linux64-static
      - name: Download macOS Intel artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-macos-x86_64
      - name: Download macOS ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-macos-arm64
      - name: Download Linux ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-linux-arm64
      - name: Download Linux ARMHF artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-linux-armhf
      - name: Download Linux i386 artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-linux-i386
      - name: Download License Manager artifact
        uses: actions/download-artifact@v4
        with:
          name: vlmcs-license-manager
      - name: Delete existing release
        run: gh release delete nightly-${{ steps.date.outputs.date }} --yes || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create Release
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            PRERELEASE="--prerelease"
          else
            PRERELEASE=""
          fi
          gh release create nightly-${{ steps.date.outputs.date }} --title "Nightly ${{ steps.date.outputs.date }}" --notes "" $PRERELEASE vlmcs-windows64.zip vlmcs-windows64-mingw.zip vlmcs-linux64-static.zip vlmcs-macos-x86_64.zip vlmcs-macos-arm64.zip vlmcs-linux-arm64.zip vlmcs-linux-armhf.zip vlmcs-linux-i386.zip vlmcs-license-manager.zip
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
